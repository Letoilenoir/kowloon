import express from "express";

import home from "./home.js";
import jwks from "./well-known/jwks.js";
import publicKey from "./well-known/publicKey.js";
import attachUserOptional from "./middleware/attachUser.js";

import activirties from "./activities/index.js";
import bookmarks from "./bookmarks/index.js";
import circles from "./circles/index.js";
import events from "./events/index.js";
import groups from "./groups/index.js";
import pages from "./pages/index.js";
import posts from "./posts/index.js";
import users from "./users/index.js";
import inbox from "./inbox/index.js";

const router = express.Router();

// Body parsers with rawBody capture for HMAC verification
router.use(
  express.json({
    limit: "5mb",
    verify: (req, res, buf) => {
      req.rawBody = buf.toString("utf8");
    },
  })
);
router.use(express.urlencoded({ extended: true }));

// Attach req.user if a valid Bearer token is present
router.use(
  attachUserOptional({ expectedAudience: `https://${process.env.DOMAIN}` })
);

// Mount routes
router.use("/activities", activirties);
router.use("/bookmarks", bookmarks);
router.use("/circles", circles);
router.use("/events", events);
router.use("/groups", groups);
router.use("/pages", pages);
router.use("/posts", posts);
router.use("/users", users);
router.use("/inbox", inbox);

router.use("/.well-known/jwks.json", jwks);
router.use("/.well-known/public.pem", publicKey);
router.use("/.well-known/publickey.pem", publicKey);
router.get("/", home);

// 404
router.use((req, res) =>
  res.status(404).json({ error: "Not found", path: req.originalUrl })
);

export default router;
